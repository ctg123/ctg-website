{
  "hash": "69ff2c2f692d6111735236256894897a",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"WordPress with LAMP Stack\"\nauthor: Chaance Graves\ndate: \"2021-08-23\" #  Aug 23, 2021\ndate-modified: \"2024-11-23\"\nimage: https://res.cloudinary.com/website-assets-mgmt/image/upload/v1732902618/Wordpress_Ansible_su8tcu.png\nformat:\n  html:\n    toc: true\n    toc-title: Contents\n    toc-location: right\n    code-fold: true\n---\n\n\nThis Playbook will install a WordPress Content Management System (CMS) within a LAMP environment (Linux, Apache, MySQL, and PHP) on two remote servers in a private network. The LAMP versioning highlights the following for each layer:\n\n* **Linux** - Ubuntu 18.04 ( 1 Virtual machine designated as the master node and two managed nodes for hosting the WordPress CMS). Vagrant and VirtualBox create these machines.\n* **Apache2** - The Apache HTTP server is the most widely-used web server in the world. It provides many powerful features, including dynamically loadable modules, robust media support, and extensive integration with other popular software.\n* **MySQL 5.7** - MySQL is the world’s most popular open-source relational database management system.\n* **PHP 7.4** - PHP is a popular general-purpose scripting language that is especially suited to web development.\n\n## Create Vagrant private network\n\nCreating a robust sandbox environment for rapid prototyping eliminates the risk of crashing or breaking other functions when using servers or your local machine when purposed for other vital tasks. We’ll create a private network that you can install on any local device (i.e., laptop) as long as VirtualBox is available via Vagrant. The `vagrantfile` seen below can build test virtual machines (VM’s) for our Ansible playbook testing environment. If you prefer using a public cloud such as AWS, Azure, GCP, or Digital Ocean, the logical design is easy to follow.\n\n\n```{ruby}\n###############\n# Vagrantfile #\n###############\n\n# -*- mode: ruby -*-\n# vi: set ft=ruby :\n\n# All Vagrant configuration is done below. The \"2\" in Vagrant.configure\n# configures the configuration version (we support older styles for\n# backwards compatibility). Please don't change it unless you know what\n# you're doing.\n\nVagrant.configure(\"2\") do |config|\n  config.vm.define \"ansible-master\" do |vm1|\n    vm1.vm.box = \"bento/ubuntu-18.04\"\n    vm1.vm.hostname = \"ansible-master\"\n    vm1.vm.network \"private_network\", ip: \"10.23.45.10\"\n\n    config.vm.provider \"virtualbox\" do |vb|\n\t  vb.gui = false\n\t  vb.memory = \"4096\"\n      vb.cpus = \"2\"\n\t  vb.customize ['modifyvm', :id, '--cableconnected1', 'on']\n    end\n\tconfig.vm.provision \"shell\", run: \"always\", inline: <<-SHELL\n\t\techo \"Welcome to the Ubuntu Ansible network.\"\n\tSHELL\n  end\n\n  config.vm.define \"ansible-node1\" do |vm2|\n    vm2.vm.box = \"bento/ubuntu-18.04\"\n    vm2.vm.hostname = \"ansible-node1\"\n    vm2.vm.network \"private_network\", ip: \"10.23.45.20\"\n\n    config.vm.provider \"virtualbox\" do |vb|\n\t  vb.gui = false\n\t  vb.memory = \"2048\"\n      vb.cpus = \"2\"\n\t  vb.customize ['modifyvm', :id, '--cableconnected1', 'on']\n    end\n\tconfig.vm.provision \"shell\", run: \"always\", inline: <<-SHELL\n\t\techo \"Welcome to the Ubuntu Ansible network.\"\n\tSHELL\n  end\n  \n  config.vm.define \"ansible-node2\" do |vm3|\n    vm3.vm.box = \"bento/ubuntu-18.04\"\n    vm3.vm.hostname = \"ansible-node2\"\n    vm3.vm.network \"private_network\", ip: \"10.23.45.30\"\n\n    config.vm.provider \"virtualbox\" do |vb|\n\t  vb.gui = false\n\t  vb.memory = \"2048\"\n      vb.cpus = \"2\"\n\t  vb.customize ['modifyvm', :id, '--cableconnected1', 'on']\n    end\n\tconfig.vm.provision \"shell\", run: \"always\", inline: <<-SHELL\n\t\techo \"Welcome to the Ubuntu Ansible network.\"\n\tSHELL\n  end\nend\n```\n\n\n## Configure the Master node and SSH connection\n\nTo begin using Ansible to manage your server infrastructure, you need to install the Ansible software on the machine that will serve as the Ansible master node. First, connect via SSH to the virtual machine.\n\n```bash\nPS C:\\\\..\\\\vagrant\\\\ubuntu_ansible> vagrant ssh ansible-master\n```\n\nBy default, `Vagrant` will be the user on the machine; however, an `admin` account with sudo privileges creates the specific purpose of using Ansible to talk to the other virtual machines in the network. Use the `adduser` command as the root user first to add a new user to your system:\n\nThere will be a prompt to enter a password of your choice.\n\n```bash\nvagrant@ansible-master:~$ sudo -i\nroot@ansible-master:~# adduser admin\n```\n\nUse the `usermod` command to add the user to the sudo group and test if the sudo commands work when logged into the user account.\n\n```bash\nroot@ansible-master:~# usermod -aG sudo admin\nroot@ansible-master:~# su - admin\n\nadmin@ansible-master:~$ sudo apt-get update\n```\n\nRun the following command to include the official project’s PPA (personal package archive) in your system’s list of sources:\n\n```bash\nadmin@ansible-master:~$ sudo apt-add-repository ppa:ansible/ansible\n```\n\nPress `ENTER` when prompted to accept the PPA addition.\n\nNext, refresh your system’s package index to be aware of the packages available in the newly included PPA and then proceed to install.\n\n```bash\nadmin@ansible-master:~$ sudo apt-get update\nadmin@ansible-master:~$ sudo apt install ansible\n```\n\n### Configure password-less authentication\n\nWe will set up password-less authentication for our admin user from master to all the managed nodes by generating a public-private key pair using `ssh-keygen`. We have pre-defined a blank password using `-P “”` This step will create private and public key pair located in the `~/.ssh` directory.\n\n```bash\nadmin@ansible-master:~$ ls -al ~/.ssh/\ntotal 20\ndrwx------ 2 admin admin 4096 Apr  3 08:03 .\ndrwxr-xr-x 6 admin admin 4096 Apr  4 22:57 ..\n-rw------- 1 admin admin 1675 Apr  3 07:49 id_rsa\n-rw-r--r-- 1 admin admin  402 Apr  3 07:49 id_rsa.pub\n-rw-r--r-- 1 admin admin  444 Apr  3 07:48 known_hosts\n```\n\nWe will use `ssh-copy-id` to copy the keys to the remote managed server and add it to `authorized_keys`.\n\n```bash\nadmin@ansible-master:~$ ssh-copy-id -i ~/.ssh/id_rsa.pub vagrant@10.23.45.20\nadmin@ansible-master:~$ ssh-copy-id -i ~/.ssh/id_rsa.pub vagrant@10.23.45.20\n```\n\n### SSH and Admin user setup with Setup playbook\n\nThe `setup_ubuntu1804` folder in the Github repository runs an independent playbook that will execute an initial server setup for the managed nodes. The options stores in the `vars/default.yml` variable file. We define the following setting below:\n\n* `create_user`: The name of the remote sudo user to create. In our case, it will be admin.\n* `copy_local_key`: Path to a local SSH public key that will be copied as an authorized key for the new user. By default, it copies the key from the current system user running Ansible.\n* `sys_packages`: An array with a list of fundamental packages to be installed.\n\nRun the playbook with the following commands.\n\n```bash\nadmin@ansible-master:~/.../setup_ubuntu1804$ ansible-playbook -i inventory -u admin playbook.yml\n```\n\nOnce the Playbook completes as successful, you can test the SSH connection with the following Ansible commands for our inventory with `ansible all -i inventory -m ping` and `ansible-inventory -i inventory --list`.\n\n```bash\nadmin@ansible-master:~/.../setup_ubuntu1804$ ansible all -i inventory -m ping\nansible-node2 | SUCCESS => {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\nansible-node1 | SUCCESS => {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\nadmin@ansible-master:~/.../wordpress-lamp_ubuntu1804$ ansible-inventory -i inventory --list\n{\n    \"_meta\": {\n        \"hostvars\": {\n            \"ansible-node1\": {\n                \"ansible_host\": \"10.23.45.20\",\n                \"ansible_python_interpreter\": \"/usr/bin/python3\"\n            },\n            \"ansible-node2\": {\n                \"ansible_host\": \"10.23.45.30\",\n                \"ansible_python_interpreter\": \"/usr/bin/python3\"\n            }\n        }\n    },\n    \"all\": {\n        \"children\": [\n            \"servers\",\n            \"ungrouped\"\n        ]\n    },\n    \"servers\": {\n        \"hosts\": [\n            \"ansible-node1\",\n            \"ansible-node2\"\n        ]\n    }\n}\n```\n\n## Run the WordPress LAMP Playbook\n\nNavigate to the `wordpress-lamp_ubuntu1804` folder and use the `tree` command to see the following structure:\n\n```bash\nadmin@ansible-master:~/wordpress-ansible/wordpress-lamp_ubuntu1804$ tree\n.\n├── files\n│   ├── apache.conf.j2\n│   ├── client.my.cnf\n│   ├── client.my.cnf.j2\n│   └── wp-config.php.j2\n├── inventory\n├── playbook.yml\n├── readme.md\n└── vars\n    └── default.yml\n```\n\nHere is the following description of what each of these files is:\n\n* `files/apache.conf.j2`: Template file for setting up the Apache VirtualHost.\n* `files/wp-config.php.j2`: Template file for setting up WordPress’s configuration file.\n* `files/client.my.cnf`: The initial client.my.cnf is provided without a password and used to obtain a connection from which roots password updates to the managed nodes we want to store for MySQL database connection.\n* `files/client.my.cnf.j2`: Contains the same structure as the initial client.my.cnf file but as a jinja2 Template file for better portability.\n* `inventory`: Keeps track of which nodes and hosts will be a part of the infrastructure on which playbooks and ad-hoc commands will run.\n* `vars/default.yml`: Variable file for customizing playbook settings.\n* `playbook.yml`: The playbook.yml file is where all tasks from this setup are defined. It starts by defining the group of servers that should target this setup (all). It uses become: true to describe that tasks should be executed with privilege escalation (sudo) by default. Then, it includes the `vars/default.yml` variable file to load configuration options.\n\nHere are the contents of each of the files respectively that should be edited:\n\n`client.my.cnf`\n\n```bash\n[client]\nuser=root\npassword=\nsocket=/var/run/mysqld/mysqld.sock\n```\n\n`client.my.cnf.j2`\n\n```bash\n[client]\nuser=root\npassword={{ mysql_password }}\nsocket=/var/run/mysqld/mysqld.sock\n```\n\n`inventory`\n\n```bash\n[servers]\nansible-node1 ansible_host=10.23.45.20\nansible-node2 ansible_host=10.23.45.30\n\n[all:vars]\nansible_python_interpreter=/usr/bin/python3\n```\n\n`vars/default.yml`\n\n```bash\n---\n#System Settings\nphp_modules: [ 'php7.4-curl', 'php7.4-cli', 'php7.4-dev', 'php7.4-gd', 'php7.4-mbstring', 'php7.4-mcrypt', 'php7.4-json', 'php7.4-tidy', 'php7.4-opcache', 'php\n7.4-xml', 'php7.4-xmlrpc', 'php7.4-pdo', 'php7.4-soap', 'php7.4-intl', 'php7.4-zip' ]\n\n#MySQL Settings\nmysql_root_password: \"Passw0rd\"\nmysql_db: \"Wordpress_db\"\nmysql_user: \"db_user\"\nmysql_password: \"admin123!\"\n\n#HTTP Settings\nhttp_host: \"your_domain\"\nhttp_conf: \"your_domain.conf\"\nhttp_port: \"80\"\n```\n\nThe following list contains a brief explanation of each of these variables if they should edit or change for any reason.\n\n* `php_modules`: An array containing PHP 7.4 extensions that support your WordPress setup. This list is extensive to support more features.\n* `mysql_root_password`: The desired password for the **root** MySQL account.\n* `mysql_db`: The name of the MySQL database intended for WordPress.\n* `mysql_user`: The name of the MySQL user for WordPress.\n* `mysql_password`: The password for the new MySQL user.\n* `http_host`: Your domain name.\n* `http_conf`: The name of the configuration file within Apache.\n* `http_port`: HTTP port for the virtual host. By default, it is `80`.\n\nOnce you’ve verified that the variables are correct, you can run the Playbook to install WordPress on the managed node(s) with the `ansible-playbook` command below:\n\n```bash\nadmin@ansible-master:~/.../wordpress-lamp_ubuntu1804$ ansible-playbook -i inventory -u admin playbook.yml\n```\n\nWhen the Playbook finishes all of its tasks, you should see a Play recap of all the events. “OK” means the task is done and configured correctly from the last run, or “changed” if Ansible finds the task alters the current state configured on the managed node(s).\n\n```bash\nPLAY RECAP ****************************************************************************************************************************************************\nansible-node1              : ok=28   changed=10   unreachable=0    failed=0    skipped=1    rescued=0    ignored=0\nansible-node2              : ok=28   changed=11   unreachable=0    failed=0    skipped=1    rescued=0    ignored=0\n```\n\nTo see if WordPress is up and running, navigate to the managed node’s domain name or IP address. In our case, it would be the following:\n\n`[<http://10.23.45.20>](<http://10.23.45.20>)` → http://10.23.45.20/wp-admin/install.php\n\n`[<http://10.23.45.30>](<http://10.23.45.30>)` → http://10.23.45.30/wp-admin/install.php\n\n![wordpress-1](https://res.cloudinary.com/website-assets-mgmt/image/upload/wordpress-1_njqf8r.png)\n\nAfter selecting the language you’d like to use for your WordPress installation, you’ll be presented with a final step to set up your WordPress user and password so you can log into your control panel. Setting up the name of your site, email, and login credentials is straightforward at this stage.\n\n![wordpress-2](https://res.cloudinary.com/website-assets-mgmt/image/upload/wordpress-2_f9hwtn.png)\n\nOnce you log in, you will be taken to the WordPress administration dashboard:\n\n![wordpress-3](https://res.cloudinary.com/website-assets-mgmt/image/upload/wordpress-3_kj0off.png)\n\nSome common next steps for customizing your WordPress installation include choosing the permalinks setting for your posts (can be found in `Settings > Permalinks`) and selecting a new theme (in `Appearance > Themes`). Below is a snapshot of our **“Hello World!”** blog post.\n\n![wordpress-4](https://res.cloudinary.com/website-assets-mgmt/image/upload/wordpress-4_xjgpdc.png)\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [],
    "includes": {}
  }
}